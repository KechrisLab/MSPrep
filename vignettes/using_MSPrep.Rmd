---
title: "Using MSPrep"
author: 
    - name: Max McGrath
      email: max.mcgrath@ucdenver.edu
      affiliation: University of Colorado Anschutz Medical Campus
    - name: Matt Mulvahill
      email: matt.mulvahill@gmail.com
      affiliation: Charter Communications
    - name: Grant Hughes
      email: dydxhughes@gmail.com
    - name: Sean Jacobson
      email: jacobsons@njhealth.org
      affiliation: National Jewish Hospital
    - name: Harrison Pielke-Lombardo
      email: harrison.pielke-lombardo@cuanschutz.edu
      affiliation: University of Colorado Anschutz Medical Campus
    - name: Katerina Kechris
      email: katerina.kechris@cuanschutz.edu
      affiliation: University of Colorado Anschutz Medical Campus
package: MSPrep
output: 
  BiocStyle::html_document:
    highlight: "tango"
    code_folding: show
    toc: true
    toc_float: 
      collapsed: false
vignette: |
  %\VignetteIndexEntry{Using MSPrep}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}  
---

```{r, include=FALSE, echo=FALSE}
# date: "`r doc_date()`"
# "`r pkg_ver('BiocStyle')`"
# <style>
#     pre {
#     white-space: pre !important;
#     overflow-y: scroll !important;
#     height: 50vh !important;
#     }
# </style>
```

# Introduction

`MSPrep` provides a convenient set of functionalities used in the pre-analytic processing pipeline for mass spectrometry based metabolomics data. Functions are included for the following processes commonly performed prior to analysis of such data:

1. Summarization of technical replicates (if available)
2. Filtering of metabolites
3. Imputation of missing values
4. Transformation, normalization, and batch correction

The sections which follow provide an explanation of each function contained in `MSPrep`, those functions' respective options, and examples of the pre-analysis pipeline using two datasets provided in the `MSPrep` package, `MSQuant` and `COPD_131`.

For further information, please see *MSPrep—Summarization, normalization and diagnostics for processing of mass spectrometry–based metabolomic data* (Hughes et al., 2014) and *Pre-analytic Considerations for Mass Spectrometry-Based Untargeted Metabolomics Data* (Reinhold et al., 2019).

```{r, echo=FALSE}
library(MSPrep)
```

# Expected Data Format

The following format is expected prior to using `MSPrep` pipeline.

Most often, two columns in the data will specify mass-to-charge ratio and retention-time. These columns may have any names (e.g. "mz" and "rt" or "Mass" and "Retention.Time") which should be specified using the `mz` and `rt` parameters of `ms_tidy()` and `ms_summarize()`.

As an addition to (or replacement of) the mass-to-charge ratio and retention-time columns, a column may be provided which provides compound names. The name of this column should be specified using the `met_id` parameter of `ms_tidy()` and `ms_summarize()`.

The next columns are for the other sample variables. These columns should have names that contain information about their contents and sample features which will be used later in the pipeline (e.g. Sample ID and batch number). There are three pieces of information which may be present at the end of each column name, spike, batch, and replicate ID. Each piece of information contained in the column names must be seperated by a consistent character not present anywhere else in the column name.

As an example see the provided dataset, `msquant`.

```{r}
data("msquant")
colnames(msquant)[3]
```

Above is the third column name in `msquant`. The first part "Neutral_Operator_Dif_Pos_" will not be used in this analysis, so we will assign it to `col_extra_txt`. The next value, "1x", is the spike-in value. The following value, "O1", is the batch. The remaining values, "A" and "01", are the replicate and subject IDs.

Identifiers in the datasets:

- LCMS_Run_ID = operator/replicate (A-C), subject (01-03), concentration  (1x,2x,4x)
- SubjectID   = subject (01-03), concentration  (1x,2x,4x)

With our data in this format, we can start the pipeline.

# Example One

Using the `msquant` dataset provided by the `MSPrep` package, the full pre-analytic processing pipeline will be demonstrated.

## Tidying

First, it is necessary to extract the information from the column names discussed above and reformat the data into a tidy data frame. This is done using the `ms_tidy()` function.

```{r}
tidied_data <- ms_tidy(msquant, 
                       mz = "mz", 
                       rt = "rt", 
                       col_extra_txt = "Neutral_Operator_Dif_Pos_", 
                       separator = "_", 
                       col_names = c("spike", "batch", "replicate", 
                                     "subject_id"))
```

Note, the names chosen for col_names are arbitratry and may be altered according to your preference, but the chosen names will be used in the next step of the pipeline.

## Summarizing

This step summarizes the technical replicates, if present, using the following procedure for each compound in each batch.

1. If there are less than a minimum proportion of the values found among the replicates (usually one or zero), leave the value empty. Otherwise proceed.
1. Calculate the coefficient of variation between the replicates using $c_v = \frac{\sigma}{\mu}$, where $\mu$ is the mean and $\sigma$ is the standard deviation.
2. For three replicates, if the coefficient of variation is above a specified level, use the median value for the compound, to correct for the large dispersion.
3. Otherwise, use the mean value of the replicates for the compound.

If no replicates are present in the data, exclude the `replicate` argument from `ms_summarize()` (or set it equal to `NULL`). In this case, the `replicate_info` and `medians` list items of the `msprep` object returned by `ms_summarize()` will be set to `NULL`.

NOTE: In the current version of `MSPrep`, `ms_summarize()` must be called prior to filtering, imputation, or normalization regardless of the presence or absence of replicates.

The technical replicates in `MSQuant` are summarized below using a CV maximum of .50 and a minimum proportion present of 1 out of 3 replicates. Note that in the `MSQuant` dataset, missing values are represented as '1', which is specified in the `missing_val` argument below. `ms_summarize` will replace these missing values with '0' in all instances where the summarization algorithm determines the values to be truly missing.

```{r}
summarized_data <- ms_summarize(tidied_data, 
                                mz = "mz", 
                                rt = "rt", 
                                replicate = "replicate", 
                                batch = "batch", 
                                groupingvars = "spike", 
                                subject_id = "subject_id", 
                                cvmax = 0.50, 
                                min_proportion_present = 1/3, 
                                missing_val = 1)
```

## Filtering

Following the summarization of technical replicates, the data needs to be filtered to only contain compounds present in a specified proportion of samples. To do so, the `ms_filter()` function is provided. By default, `ms_filter()` uses the '80%` rule and removes compounds which are are not present in 80% of the samples.

```{r}
filtered_data <- ms_filter(summarized_data, 
                           filter_percent = 0.8)
```

## Imputation

Next, depending on the downstream analysis, you may need to impute missing data. Three imputation methods are provided:

1. half-min (half the minimum value)
2. bpca (Bayesian PCA), 
3. knn (k-nearest neighbors)

Half-min performs faster than other methods, but may introduce bias. BPCA imputes the data using a number of principle components specified by the user with the `n_pcs` arugment. KNN typically takes the longest. Users may provide their preferred value of k using the `k_knn` argument. Further, by default, KNN uses samples as neighbors. By specifiying `compoundsAsNeighbors = TRUE`, compounds will be used as neighbors instead. Note that this is significantly slower than using samples as neighbors and may take several minutes or more to run depending on the size of your dataset.

```{r}
imputed_data <- ms_impute(filtered_data, 
                          imputeMethod ="knn", 
                          k_knn = 5)
```

## Normalization

In order to make comparisons between samples, the data may need to be transformed and normalized This step performs one of eight normalization strategies. 

1. Median
2. ComBat
3. Quantile
4. quantile + ComBat
5. median + ComBat
6. CRMN
7. RUV
8. SVA

Note that all methods involving ComBat may only be used on data that contains batches. Similarly, SVA and CRMN normalization may only be used on data sets that use spike-ins (internal standards). 

The argument `transform` enables the transformation of data prior to normalization using a log base 10 ("log10") or base 2 ("log2") transformation. Specify "none" to bypass transformation. 

For experiments which have control compounds, a list of the column numbers containing them should be provided in the controls variable. Otherwise, simply leave the controls parameter blank or NULL. 

For RUV normalization, the `k_ruv` argument specifies the number of factors on which the data is normalized.

```{r}
normalized_data <- ms_normalize(imputed_data, 
                                normalizeMethod ="CRMN", 
                                controls = NULL,  
                                n_comp = 2, 
                                n_control = 10, 
                                transform = "log10")
```

## Returning

Throughout the above functions, an elongated version of the provided data is used. This long dataset has columns corresponding to metabolite mass-to-charge ratio, retention time, abundance, and sample features like subject, replicates, and spike-ins, and it has rows corresponding to each unique combination of the sample features. 

To return the data to a wide format with metabolites as rows and samples as columns, use the `ms_return()` function.

```{r}
returned_data <- ms_return(normalized_data)
```

## Pipeline

Often, all the above steps will need to be conducted. This can be done in a single statement using the `ms_prepare()` function. Simply provide the function the same arguments that you would provide to the individual functions. 

```{r}

prepared_data <- ms_prepare(msquant, 
                            mz = "mz",
                            rt = "rt",
                            col_extra_txt = "Neutral_Operator_Dif_Pos_", 
                            separator = "_", 
                            col_names = c("spike", 
                                          "batch", 
                                          "replicate", 
                                          "subject_id"),
                            replicate = "replicate",
                            batch = "batch",
                            subject_id = "subject_id",
                            groupingvars = "spike",
                            filter_percent = .8,
                            imputeMethod = "halfmin",
                            normalizeMethod = "quantile")
```

## Printing

At any point in the pipeline after `ms_summarize()`, the `print()` function provided by `MSPrep` can be called on an `msprep` object. This will print the stage of the pipeline that the object is in, along with information pertaining to each step of the pipeline.

```{r}
print(prepared_data)
```


# Example Two

Next, the functionality of `MSPrep` will be demonstrated using the included data `COPD_131`. The raw dataset can be found [here, at Metabolomics Workbench.](https://www.metabolomicsworkbench.org/data/DRCCMetadata.php?Mode=Project&ProjectID=PR000438) Note that only a portion of the `COPD_131` dataset is included in this package in order to limit file size and improve example performance. Generally, the number of metabolites will be far greater than the number of samples and the functions included in this package will take more time to process the data.

This dataset differs from `msquant` in several ways. First, it has a column `Compound.Name` which specifies compound names, and the mass-to-charge ratio and retention-time columns are named `Mass` and `Retention.Time` respectively. Second, this dataset does not have spike-ins or batches (but it does have technical replicates). Finally, the data has already been normalized so that step of the pipeline will be excluded.

## Tidying

```{r}
data("COPD_131")
strsplit(colnames(COPD_131)[4], "_")
```

As with before, the data must first be reformated into a tidy dataframe. In this dataset, there are two features present in the column names: subject and replicate number, seperated by '_'. Also, the extra text 'X' appears before each column name. So, `ms_tidy()` is run as follows:

```{r}
tidied_data_131 <- ms_tidy(COPD_131,
                           met_id = "Compound.Name",
                           mz = "Mass", 
                           rt = "Retention.Time",
                           col_extra_txt = "X", 
                           separator = "_",
                           col_names = c("subject_id", "replicate"))
```

## Summarizing

Next, the technical replicates in `COPD_131` need to be summarized. This process is largely the same as before, but with different column names specified, so `ms_summarize()` is called as follows:

```{r}
summarized_data_131 <- ms_summarize(tidied_data_131,
                                    met_id = "Compound.Name",
                                    mz = "Mass", 
                                    rt = "Retention.Time", 
                                    subject_id = "subject_id", 
                                    replicate = "replicate",
                                    cvmax = 0.50, 
                                    min_proportion_present = 1/3, 
                                    missing_val = 0)
```

## Filtering

Again, this process is largely the same as before, choosing a filter percentage of 0.8. So, we call `ms_filter()` as follows:

```{r}
filtered_data_131 <- ms_filter(summarized_data_131, 
                               filter_percent = 0.8)
```

## Imputing

For this example, `ms_impute()` will be called using Bayesian PCA using three principle components to impute the missing values for the data.

```{r}
imputed_data_131 <- ms_impute(filtered_data_131, 
                              imputeMethod ="bpca", 
                              n_pcs = 3)
```

## Returning

As previously mentioned, throughout the `MSPrep` pipeline data is stored in a long format `Data Frame`. As it may be preferable to return the data to a typical format with compounds as rows and samples as columns, the function `ms_return()` is provided to do so.

```{r}
returned_data_131 <- ms_return(imputed_data_131)
```


## Pipeline

As with the previous example, the above steps can be performed in a pipeline using the `ms_prepare()` function. To skip the normalization step of the pipeline, set the `normalizeMethod` paramater to "none" (note that the same can be done for imputationMethod).

```{r}
prepared_data_131 <- ms_prepare(COPD_131,
                  met_id = "Compound.Name",
                  mz = "Mass", 
                  rt = "Retention.Time",
                  col_extra_txt = "X", 
                  separator = "_",
                  col_names = c("subject_id", "replicate"),
                  subject_id = "subject_id", 
                  replicate = "replicate",
                  cvmax = 0.50, 
                  min_proportion_present = 1/3, 
                  missing_val = 0,
                  filter_percent=0.8,
                  imputeMethod ="bpca", 
                  n_pcs = 3,
                  normalizeMethod = "none")
```

## Printing

As with before, the prepared COPD_131 `msprep` object may be passed to the `print()` function provided to print its status in the pipeline, along with information pertaining to each step of the pipeline.

```{r}
print(prepared_data_131)
```

# Session Info

```{r}
sessionInfo()
```

